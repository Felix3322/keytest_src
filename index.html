<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenAI API Key Checker</title>
  <script>
    // Check using the models endpoint
    async function checkAPIKeyModels() {
      var apiKey = document.getElementById("apiKey").value;
      // Use the provided API base or default to OpenAI's official base
      var apiBase = document.getElementById("apiBase").value || "https://api.openai.com";
      var resultDiv = document.getElementById("result");

      if (!apiKey) {
        resultDiv.innerHTML = "Please enter an API key.";
        return;
      }

      resultDiv.innerHTML = "Checking via models endpoint...";

      try {
        const response = await fetch(apiBase + "/v1/models", {
          method: "GET",
          headers: {
            "Authorization": "Bearer " + apiKey
          }
        });

        const data = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = "API Key is valid (Models endpoint).";
        } else {
          var errorMsg = data.error ? data.error.message : "Invalid API Key.";
          resultDiv.innerHTML = "Error: " + errorMsg;
        }
      } catch (error) {
        resultDiv.innerHTML = "Failed to connect. Check your network.";
      }
    }

    // Load models for selection using the models endpoint
    async function loadModels() {
      var apiKey = document.getElementById("apiKey").value;
      var apiBase = document.getElementById("apiBase").value || "https://api.openai.com";
      var modelSelect = document.getElementById("modelSelect");
      var resultDiv = document.getElementById("result");

      if (!apiKey) {
        resultDiv.innerHTML = "Please enter an API key to load models.";
        return;
      }

      resultDiv.innerHTML = "Loading model list...";

      try {
        const response = await fetch(apiBase + "/v1/models", {
          method: "GET",
          headers: {
            "Authorization": "Bearer " + apiKey
          }
        });

        const data = await response.json();

        if (response.ok) {
          // Clear the dropdown first
          modelSelect.innerHTML = "";
          // Add a default option
          var defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.text = "Select a model";
          modelSelect.appendChild(defaultOption);

          // Populate the dropdown with fetched models (if any)
          if (data.data && Array.isArray(data.data)) {
            data.data.forEach(function(model) {
              var option = document.createElement("option");
              option.value = model.id;
              option.text = model.id;
              modelSelect.appendChild(option);
            });
          }
          resultDiv.innerHTML = "Model list loaded.";
        } else {
          modelSelect.innerHTML = "";
          var errorMsg = data.error ? data.error.message : "Failed to load models.";
          resultDiv.innerHTML = "Error: " + errorMsg;
        }
      } catch (error) {
        modelSelect.innerHTML = "";
        resultDiv.innerHTML = "Failed to load models. Check your network.";
      }
    }

    // Check using a text completion test with model selection
    async function checkAPIKeyTextTest() {
      var apiKey = document.getElementById("apiKey").value;
      var apiBase = document.getElementById("apiBase").value || "https://api.openai.com";
      var resultDiv = document.getElementById("result");

      if (!apiKey) {
        resultDiv.innerHTML = "Please enter an API key.";
        return;
      }

      // Determine which model to use:
      // Priority: custom model input > dropdown selection > default model
      var customModel = document.getElementById("customModel").value.trim();
      var selectedModel = document.getElementById("modelSelect").value;
      var modelToUse = customModel || selectedModel || "text-davinci-003";

      resultDiv.innerHTML = "Checking via text test using model: " + modelToUse + "...";

      try {
        const response = await fetch(apiBase + "/v1/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: modelToUse,
            prompt: "Hello",
            max_tokens: 5,
            temperature: 0
          })
        });

        const data = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = "API Key is valid (Text test using model: " + modelToUse + ").";
        } else {
          var errorMsg = data.error ? data.error.message : "Invalid API Key.";
          resultDiv.innerHTML = "Error: " + errorMsg;
        }
      } catch (error) {
        resultDiv.innerHTML = "Failed to connect. Check your network.";
      }
    }

    // Clear all input fields and result display
    function clearInput() {
      document.getElementById("apiKey").value = "";
      document.getElementById("apiBase").value = "";
      document.getElementById("modelSelect").innerHTML = "";
      document.getElementById("customModel").value = "";
      document.getElementById("result").innerHTML = "";
    }
  </script>
</head>
<body>
  <h2>OpenAI API Key Checker</h2>

  <!-- API Base Input Field -->
  <p>API Base (optional):</p>
  <input type="text" id="apiBase" size="50" placeholder="https://api.openai.com">
  <br><br>

  <!-- API Key Input Field -->
  <p>Enter API Key:</p>
  <input type="text" id="apiKey" size="50" placeholder="sk-...">
  <br><br>

  <!-- Buttons for checking methods -->
  <button onclick="checkAPIKeyModels()">Check (Models)</button>
  <button onclick="checkAPIKeyTextTest()">Check (Text Test)</button>
  <button onclick="clearInput()">Clear</button>
  <br><br>

  <!-- Model Selection for Text Test -->
  <p>
    <strong>Model Selection for Text Test:</strong>
    <br>
    <button onclick="loadModels()">Load Models</button>
  </p>
  <p>
    Choose from the list:
    <select id="modelSelect">
      <!-- Model options will be populated here -->
    </select>
  </p>
  <p>
    Or enter a custom model (optional):
    <input type="text" id="customModel" size="50" placeholder="e.g., text-davinci-003">
  </p>

  <!-- Result Display -->
  <p id="result"></p>

  <!-- Open source project reference -->
  <p>Open source project for security verification:</p>
  <a href="https://github.com/Felix3322/keytest_src" target="_blank">
    <img src="IMG_3788.png" width="40" height="40" alt="GitHub Repository">
  </a>

  <hr>
  <p>
    Copyright © Felix3322.
    Source code is for inspection only and may not be used for other purposes.
  </p>

  <!-- Note for third-party API bases -->
  <p>
    Note: When using a third-party API base, the models endpoint may misreport the key’s validity.
    It is recommended to use the "Text Test" method.
  </p>
</body>
</html>